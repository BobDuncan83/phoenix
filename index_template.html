<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roth IRA Portfolio Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
        }
        
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .over-limit {
            background: linear-gradient(90deg, #dc3545 0%, #c82333 100%) !important;
        }
        
        .action-buy {
            color: #28a745;
            font-weight: 600;
        }
        
        .action-sell {
            color: #dc3545;
            font-weight: 600;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.9em;
                white-space: nowrap;
                min-width: max-content;
            }
            
            .tab-content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .section h2 {
                font-size: 1.4em;
                margin-bottom: 15px;
            }
            
            .section h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
            
            .section p {
                font-size: 0.9em;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stat-card {
                margin-bottom: 10px;
                padding: 15px;
            }
            
            .stat-card h4 {
                font-size: 0.75em;
                margin-bottom: 8px;
            }
            
            .stat-card .value {
                font-size: 1.6em;
            }
            
            .stat-card div {
                font-size: 0.85em;
            }
            
            table {
                font-size: 0.8em;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            table tbody {
                display: table;
                width: 100%;
            }
            
            th, td {
                padding: 10px 8px;
                min-width: 80px;
            }
            
            th:first-child, td:first-child {
                position: sticky;
                left: 0;
                background: inherit;
                z-index: 1;
            }
            
            th {
                background: #667eea !important;
            }
            
            input[type="number"], input[type="text"] {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px 8px;
                min-width: 100px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
                margin-right: 0;
                padding: 14px;
                font-size: 1em;
            }
            
            .alert {
                padding: 12px;
                font-size: 0.85em;
                line-height: 1.4;
            }
            
            .progress-bar {
                height: 22px;
            }
            
            .progress-fill {
                font-size: 0.75em;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 0;
            }
            
            .container {
                border-radius: 0;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.85em;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 0.85em;
            }
            
            .section h2 {
                font-size: 1.2em;
            }
            
            .section h3 {
                font-size: 1em;
            }
            
            table {
                font-size: 0.75em;
            }
            
            th, td {
                padding: 8px 6px;
                min-width: 70px;
            }
            
            .stat-card .value {
                font-size: 1.4em;
            }
            
            input[type="number"], input[type="text"] {
                padding: 8px 6px;
                font-size: 16px;
            }
            
            .btn {
                padding: 12px;
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Roth IRA Portfolio Manager</h1>
            <p>Track, Analyze, and Rebalance Your Investment Portfolio</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">Portfolio Overview</button>
            <button class="tab" onclick="showTab('overall')">Overall Allocation</button>
            <button class="tab" onclick="showTab('rebalance')">Core Rebalancing</button>
            <button class="tab" onclick="showTab('dividend')">Dividend Holdings</button>
            <button class="tab" onclick="showTab('dividendtracker')">Dividend Tracker</button>
            <button class="tab" onclick="showTab('prices')">Holdings Summary</button>
            <button class="tab" onclick="showTab('cashflow')">Cash Flow Planner</button>
        </div>
        
        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="grid">
                <div class="stat-card">
                    <h4>Total Portfolio Value</h4>
                    <div class="value" id="totalValue">$0.00</div>
                </div>
                <div class="stat-card">
                    <h4>Total Equity</h4>
                    <div class="value" id="totalEquity">0%</div>
                </div>
                <div class="stat-card">
                    <h4>Total Bonds</h4>
                    <div class="value" id="totalBonds">0%</div>
                </div>
                <div class="stat-card">
                    <h4>Total Cash</h4>
                    <div class="value" id="totalCash">0%</div>
                </div>
            </div>
            
            <div class="section">
                <h2>Overall Allocation</h2>
                <div id="overallAllocation"></div>
            </div>
            
            <div class="section">
                <h2>Asset Breakdown</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Current Value</th>
                            <th>Percentage</th>
                            <th>Allocation Bar</th>
                        </tr>
                    </thead>
                    <tbody id="assetBreakdown">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- OVERALL ALLOCATION TAB -->
        <div id="overall" class="tab-content">
            <div class="section">
                <h2>Complete Portfolio Allocation</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Combined view of Core Holdings + Dividend Stocks</p>
                
                <div style="margin-bottom: 20px; padding: 20px; background: white; border-radius: 10px;">
                    <h3 style="margin-bottom: 15px;">Your Target Allocation Strategy</h3>
                    <select id="target_strategy" style="width: 100%; max-width: 400px; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em;" onchange="updateOverallAllocation()">
                        <option value="conservative">Conservative (50% equity / 50% bonds+cash)</option>
                        <option value="moderate" selected>Moderate (65% equity / 35% bonds+cash)</option>
                        <option value="mod-aggressive">Moderately Aggressive (75% equity / 25% bonds+cash)</option>
                        <option value="aggressive">Aggressive (90% equity / 10% bonds+cash)</option>
                    </select>
                    <p style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                        ‚ö†Ô∏è You'll be warned if your overall portfolio drifts more than 5% from this target
                    </p>
                </div>
                
                <div class="grid">
                    <div class="stat-card">
                        <h4>Total Portfolio Value</h4>
                        <div class="value" id="overall_total">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Equity Allocation</h4>
                        <div class="value" id="overall_equity_pct">0%</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Bonds Allocation</h4>
                        <div class="value" id="overall_bonds_pct">0%</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Cash Allocation</h4>
                        <div class="value" id="overall_cash_pct">0%</div>
                    </div>
                </div>
                
                <div id="overall_classification"></div>
            </div>
            
            <div class="section">
                <h2>Allocation Breakdown by Source</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Total Value</th>
                            <th>Equity</th>
                            <th>Bonds</th>
                            <th>Cash</th>
                        </tr>
                    </thead>
                    <tbody id="overall_breakdown">
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>Detailed Equity Breakdown</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Value</th>
                            <th>% of Total Portfolio</th>
                            <th>% of Total Equity</th>
                        </tr>
                    </thead>
                    <tbody id="equity_breakdown">
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>Target vs Actual</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Compare your actual allocation to common portfolio strategies</p>
                
                <table>
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Target Equity</th>
                            <th>Your Equity</th>
                            <th>Difference</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="strategy_comparison">
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>Drift Warnings</h2>
                <div id="drift_warnings"></div>
            </div>
            
            <div class="section">
                <h2>Core Allocation Recommendations</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">To maintain your target overall allocation, here's what your core holdings should be:</p>
                <div id="core_recommendations"></div>
            </div>
        </div>
        
        <!-- CORE REBALANCING TAB -->
        <div id="rebalance" class="tab-content">
            <div class="section">
                <h2>Target Allocation Strategy</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Select a preset allocation or customize your own</p>
                
                <div class="grid">
                    <div class="stat-card" style="cursor: pointer;" onclick="setAllocation('conservative')">
                        <h4>Conservative (40/60)</h4>
                        <div style="font-size: 1em; color: #6c757d;">40% Stocks / 60% Bonds+Cash</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Low risk, stable income</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="setAllocation('moderate')">
                        <h4>Moderate (65/35)</h4>
                        <div style="font-size: 1em; color: #6c757d;">65% Stocks / 35% Bonds+Cash</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Balanced growth & stability</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="setAllocation('mod-aggressive')">
                        <h4>Moderately Aggressive (75/25)</h4>
                        <div style="font-size: 1em; color: #6c757d;">75% Stocks / 25% Bonds+Cash</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Growth-focused</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="setAllocation('aggressive')">
                        <h4>Aggressive (90/10)</h4>
                        <div style="font-size: 1em; color: #6c757d;">90% Stocks / 10% Bonds+Cash</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Maximum growth</div>
                    </div>
                </div>
                
                <div class="alert alert-info" id="allocationInfo">
                    <strong>Current Strategy: Moderate (65/35)</strong><br>
                    Click on a strategy above to automatically adjust all target percentages.
                </div>
            </div>
            
            <div class="section">
                <h2>Core Holdings</h2>
                <p style="margin-bottom: 15px; color: #6c757d;">Your main portfolio holdings for broad market exposure</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="editCoreHoldings()">‚úèÔ∏è Edit Core Holdings</button>
                    <button class="btn btn-secondary" onclick="saveCoreHoldings()">üíæ Save Core Settings</button>
                </div>
                
                <div id="coreEditMode" style="display: none; margin-bottom: 20px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
                    <h3 style="color: #856404;">‚ö†Ô∏è Edit Mode Active</h3>
                    <p style="color: #856404; margin-bottom: 15px;">You can now change ticker symbols and asset classes. Click a ticker or asset class to edit it.</p>
                    <button class="btn" onclick="exitEditMode()">Done Editing</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Asset Class</th>
                            <th>Shares</th>
                            <th>Value ($)</th>
                            <th>Yield (%)</th>
                            <th>Current %</th>
                            <th>Target %</th>
                            <th>Target $ </th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="coreHoldings">
                    </tbody>
                </table>
                
                <div id="targetValidation" style="margin-top: 20px;"></div>
                
                <button class="btn" onclick="calculateRebalance()">Calculate Rebalancing</button>
                <button class="btn btn-secondary" onclick="exportRebalance()">Export Plan</button>
                <button class="btn btn-secondary" onclick="autoAdjustTargets()">Auto-Adjust to 100%</button>
            </div>
            
            <div class="section" id="rebalanceResults" style="display:none;">
                <h2>Rebalancing Actions</h2>
                <div id="rebalanceActions"></div>
            </div>
        </div>
        
        <!-- DIVIDEND HOLDINGS TAB -->
        <div id="dividend" class="tab-content">
            <div class="section">
                <h2>Dividend Stock Holdings</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">30% sector limit enforced on all holdings</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="showAddHoldingForm()">+ Add New Holding</button>
                    <button class="btn btn-secondary" onclick="saveDividendHoldings()">üíæ Save Changes</button>
                </div>
                
                <div id="addHoldingForm" style="display: none; margin-bottom: 20px; padding: 20px; background: white; border-radius: 10px;">
                    <h3>Add New Holding</h3>
                    <table>
                        <tr>
                            <td>Ticker Symbol:</td>
                            <td><input type="text" id="new_ticker" placeholder="e.g., AAPL" style="text-transform: uppercase;"></td>
                        </tr>
                        <tr>
                            <td>Current Value ($):</td>
                            <td><input type="number" id="new_value" placeholder="0.00" step="0.01"></td>
                        </tr>
                        <tr>
                            <td>Sector:</td>
                            <td>
                                <select id="new_sector" style="width: 100%; padding: 8px; border: 2px solid #dee2e6; border-radius: 5px;">
                                    <option value="">Select sector...</option>
                                    <option value="Healthcare/Biotech">Healthcare/Biotech</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Financial">Financial</option>
                                    <option value="Consumer Staples">Consumer Staples</option>
                                    <option value="Energy">Energy</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Industrials">Industrials</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Business Services">Business Services</option>
                                    <option value="Aerospace/Defense">Aerospace/Defense</option>
                                    <option value="Communication">Communication</option>
                                    <option value="Real Estate">Real Estate</option>
                                    <option value="Consumer Discretionary">Consumer Discretionary</option>
                                    <option value="Materials">Materials</option>
                                    <option value="Alternative Energy">Alternative Energy</option>
                                    <option value="Closed-End Fund">Closed-End Fund</option>
                                    <option value="Conglomerate">Conglomerate</option>
                                    <option value="Cash">Cash</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <button class="btn" onclick="addHolding()">Add Holding</button>
                    <button class="btn btn-secondary" onclick="hideAddHoldingForm()">Cancel</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Sector</th>
                            <th>Shares</th>
                            <th>Value ($)</th>
                            <th>Yield (%)</th>
                            <th>% of Portfolio</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dividendHoldings">
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 10px;">
                    <h3>Free Cash</h3>
                    <p style="color: #6c757d; margin-bottom: 10px;">Cash not invested in money market funds</p>
                    <input type="number" id="freeCashInput" step="0.01" style="width: 200px;" onchange="updateFreeCash()">
                </div>
            </div>
            
            <div class="section">
                <h2>Sector Allocation Monitor</h2>
                <div id="sectorMonitor"></div>
            </div>
            
            <div class="section">
                <h2>Investment Headroom by Sector</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">How much can you add to each sector before hitting 30% limit</p>
                <table>
                    <thead>
                        <tr>
                            <th>Sector</th>
                            <th>Current %</th>
                            <th>Remaining Headroom ($)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="headroomTable">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- DIVIDEND TRACKER TAB -->
        <div id="dividendtracker" class="tab-content">
            <div class="section">
                <h2>Dividend Income Tracker</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Log dividend payments and track your income over time</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="showAddDividendForm()">+ Log Dividend Payment</button>
                    <button class="btn btn-secondary" onclick="saveDividendPayments()">üíæ Save Dividend Data</button>
                </div>
                
                <div id="addDividendForm" style="display: none; margin-bottom: 20px; padding: 20px; background: white; border-radius: 10px;">
                    <h3>Log Dividend Payment</h3>
                    <table>
                        <tr>
                            <td>Ticker:</td>
                            <td>
                                <select id="div_ticker" style="width: 100%; padding: 8px; border: 2px solid #dee2e6; border-radius: 5px;">
                                    <option value="">Select ticker...</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Payment Date:</td>
                            <td><input type="date" id="div_date"></td>
                        </tr>
                        <tr>
                            <td>Amount ($):</td>
                            <td><input type="number" id="div_amount" placeholder="0.00" step="0.01"></td>
                        </tr>
                    </table>
                    <button class="btn" onclick="addDividendPayment()">Log Payment</button>
                    <button class="btn btn-secondary" onclick="hideAddDividendForm()">Cancel</button>
                </div>
            </div>
            
            <div class="section">
                <h2>Dividend Summary</h2>
                <div class="grid">
                    <div class="stat-card">
                        <h4>Total Dividends (All Time)</h4>
                        <div class="value" id="total_dividends_all">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4>This Year</h4>
                        <div class="value" id="total_dividends_year">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4>Last 12 Months</h4>
                        <div class="value" id="total_dividends_12mo">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4>Projected Annual</h4>
                        <div class="value" id="projected_annual">$0.00</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Dividend History</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Ticker</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dividendHistory">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #6c757d;">No dividend payments logged yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>Income by Holding</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Total Received</th>
                            <th>Last 12 Months</th>
                            <th>Number of Payments</th>
                        </tr>
                    </thead>
                    <tbody id="dividendByHolding">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- PRICE UPDATES TAB -->
        <div id="prices" class="tab-content">
            <div class="section">
                <h2>Holdings Summary</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">View all your share counts, values, and yields in one place. Data entered in Core Rebalancing and Dividend Holdings tabs automatically appears here.</p>
                
                <div class="alert alert-info" style="margin-bottom: 20px;">
                    <strong>üìù One-Time Entry System:</strong><br>
                    ‚Ä¢ Go to <strong>Core Rebalancing</strong> tab ‚Üí Enter shares, yield %, and values ‚Üí Syncs here automatically<br>
                    ‚Ä¢ Go to <strong>Dividend Holdings</strong> tab ‚Üí Enter shares, yield %, and values ‚Üí Syncs here automatically<br>
                    ‚Ä¢ <strong>Dividend Tracker</strong> uses your yields to project annual income<br>
                    ‚Ä¢ Enter data once, use everywhere!
                </div>
            </div>
            
            <div class="section">
                <h2>Core Holdings Summary</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Shares</th>
                            <th>Current Value</th>
                            <th>Yield (%)</th>
                            <th>Annual Income</th>
                        </tr>
                    </thead>
                    <tbody id="coreHoldingsSummary">
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>Dividend Holdings Summary</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Ticker</th>
                            <th>Shares</th>
                            <th>Current Value</th>
                            <th>Yield (%)</th>
                            <th>Annual Income</th>
                        </tr>
                    </thead>
                    <tbody id="dividendHoldingsSummary">
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>Total Portfolio</h2>
                <div class="grid">
                    <div class="stat-card">
                        <h4>Total Portfolio Value</h4>
                        <div class="value" id="summary_total_value">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4>Weighted Avg Yield</h4>
                        <div class="value" id="avg_yield">0%</div>
                    </div>
                    <div class="stat-card">
                        <h4>Projected Annual Income</h4>
                        <div class="value" id="summary_annual_income">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4>Monthly Income (Est.)</h4>
                        <div class="value" id="monthly_income">$0.00</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CASH FLOW PLANNER TAB -->
        <div id="cashflow" class="tab-content">
            <div class="section">
                <h2>2026 Cash Flow Projection</h2>
                
                <div class="grid">
                    <div class="stat-card">
                        <h4>Starting Cash</h4>
                        <div class="value" id="cf_starting">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h4>Months Remaining</h4>
                        <div class="value" id="cf_months">12</div>
                    </div>
                    <div class="stat-card">
                        <h4>Monthly Investment</h4>
                        <div class="value" id="cf_monthly">$1,000</div>
                    </div>
                    <div class="stat-card">
                        <h4>Projected End Cash</h4>
                        <div class="value" id="cf_ending">$0.00</div>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Setting</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Current Cash Balance (SWVXX + Free Cash)</td>
                            <td><input type="number" id="input_current_cash" value="0" step="0.01" onchange="updateCashFlow()"></td>
                        </tr>
                        <tr>
                            <td>New Money to Add in 2026</td>
                            <td><input type="number" id="input_new_money_2026" value="0" step="0.01" onchange="updateCashFlow()"></td>
                        </tr>
                        <tr>
                            <td>Remaining Months in 2026</td>
                            <td><input type="number" id="input_months_remaining" value="12" step="1" onchange="updateCashFlow()"></td>
                        </tr>
                        <tr>
                            <td>Monthly Investment Amount</td>
                            <td><input type="number" id="input_monthly_investment" value="1000" step="0.01" onchange="updateCashFlow()"></td>
                        </tr>
                    </tbody>
                </table>
                
                <button class="btn" onclick="updateCashFlow()">Recalculate</button>
            </div>
            
            <div class="section">
                <h2>2027 Setup</h2>
                <div class="grid">
                    <div class="stat-card">
                        <h4>Cash from 2026</h4>
                        <div class="value" id="cf_2027_carry">$0</div>
                    </div>
                    <div class="stat-card">
                        <h4>New Money for 2027</h4>
                        <div class="value">$7,500</div>
                    </div>
                    <div class="stat-card">
                        <h4>Total Available 2027</h4>
                        <div class="value" id="cf_2027_total">$0</div>
                    </div>
                    <div class="stat-card">
                        <h4>2027 Monthly Budget</h4>
                        <div class="value">$1,000</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Multi-Year Self-Sustainability Projection</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">See when your dividend income will cover your investment needs</p>
                
                <table>
                    <thead>
                        <tr>
                            <th>Settings</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Current Dividend Portfolio Value</td>
                            <td><input type="number" id="proj_current_portfolio" value="0" step="0.01" onchange="calculateProjection()"></td>
                        </tr>
                        <tr>
                            <td>Average Dividend Yield (%)</td>
                            <td><input type="number" id="proj_yield" value="3.5" step="0.1" onchange="calculateProjection()"></td>
                        </tr>
                        <tr>
                            <td>Annual Contribution (New Money)</td>
                            <td><input type="number" id="proj_annual_contribution" value="7500" step="100" onchange="calculateProjection()"></td>
                        </tr>
                        <tr>
                            <td>Annual Investment Need (12 √ó Monthly)</td>
                            <td><input type="number" id="proj_annual_need" value="12000" step="100" onchange="calculateProjection()"></td>
                        </tr>
                        <tr>
                            <td>Annual Portfolio Growth (%)</td>
                            <td><input type="number" id="proj_growth" value="7" step="0.5" onchange="calculateProjection()"></td>
                        </tr>
                    </tbody>
                </table>
                
                <button class="btn" onclick="calculateProjection()">Calculate Projection</button>
                
                <div id="projectionResults" style="margin-top: 20px;"></div>
            </div>
            
            <div class="section">
                <h2>Monthly Investment Tracker</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Track which securities you invest in each month</p>
                <table>
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Security</th>
                            <th>Amount</th>
                            <th>Sector</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTracker">
                        <tr>
                            <td>February 2026</td>
                            <td><input type="text" id="feb_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="feb_amount" value="1000" step="0.01"></td>
                            <td id="feb_sector">-</td>
                        </tr>
                        <tr>
                            <td>March 2026</td>
                            <td><input type="text" id="mar_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="mar_amount" placeholder="0" step="0.01"></td>
                            <td id="mar_sector">-</td>
                        </tr>
                        <tr>
                            <td>April 2026</td>
                            <td><input type="text" id="apr_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="apr_amount" placeholder="0" step="0.01"></td>
                            <td id="apr_sector">-</td>
                        </tr>
                        <tr>
                            <td>May 2026</td>
                            <td><input type="text" id="may_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="may_amount" placeholder="0" step="0.01"></td>
                            <td id="may_sector">-</td>
                        </tr>
                        <tr>
                            <td>June 2026</td>
                            <td><input type="text" id="jun_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="jun_amount" placeholder="0" step="0.01"></td>
                            <td id="jun_sector">-</td>
                        </tr>
                        <tr>
                            <td>July 2026</td>
                            <td><input type="text" id="jul_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="jul_amount" placeholder="0" step="0.01"></td>
                            <td id="jul_sector">-</td>
                        </tr>
                        <tr>
                            <td>August 2026</td>
                            <td><input type="text" id="aug_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="aug_amount" placeholder="0" step="0.01"></td>
                            <td id="aug_sector">-</td>
                        </tr>
                        <tr>
                            <td>September 2026</td>
                            <td><input type="text" id="sep_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="sep_amount" placeholder="0" step="0.01"></td>
                            <td id="sep_sector">-</td>
                        </tr>
                        <tr>
                            <td>October 2026</td>
                            <td><input type="text" id="oct_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="oct_amount" placeholder="0" step="0.01"></td>
                            <td id="oct_sector">-</td>
                        </tr>
                        <tr>
                            <td>November 2026</td>
                            <td><input type="text" id="nov_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="nov_amount" placeholder="0" step="0.01"></td>
                            <td id="nov_sector">-</td>
                        </tr>
                        <tr>
                            <td>December 2026</td>
                            <td><input type="text" id="dec_security" placeholder="Enter ticker"></td>
                            <td><input type="number" id="dec_amount" placeholder="0" step="0.01"></td>
                            <td id="dec_sector">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Portfolio data - CLEAN TEMPLATE (enter your own data in the tool)
        let dividendHoldings = {};
        
        let freeCash = 0;
        
        // Dividend payments history
        let dividendPayments = [];
        
        // Share counts for price updates - will sync from holdings
        let shareCounts = {};
        let lastPrices = {};
        
        // Core holdings structure - now editable with shares and yield
        let coreHoldings = {
            'core1': {ticker: 'SWPPX', name: 'US Equity', assetClass: 'equity', shares: 0, yield: 0, targetPct: 42},
            'core2': {ticker: 'VWO', name: 'Intl Equity (EM)', assetClass: 'equity', shares: 0, yield: 0, targetPct: 8},
            'core3': {ticker: 'SCHF', name: 'Intl Equity (Dev)', assetClass: 'equity', shares: 0, yield: 0, targetPct: 15},
            'core4': {ticker: 'BND', name: 'Bonds', assetClass: 'bonds', shares: 0, yield: 0, targetPct: 30},
            'core5': {ticker: 'SCHO', name: 'Cash/Short-term', assetClass: 'cash', shares: 0, yield: 0, targetPct: 5}
        };
        
        let coreEditMode = false;
        
        // Helper function to get core asset breakdown
        function getCoreAssetBreakdown() {
            const tickers = Object.values(coreHoldings).map(h => h.ticker.toLowerCase());
            let coreTotal = 0;
            let coreEquity = 0;
            let coreBonds = 0;
            let coreCash = 0;
            
            tickers.forEach(ticker => {
                const value = parseFloat(document.getElementById('core_' + ticker)?.value) || 0;
                coreTotal += value;
                
                const holding = Object.values(coreHoldings).find(h => h.ticker.toLowerCase() === ticker);
                if (holding) {
                    if (holding.assetClass === 'equity') {
                        coreEquity += value;
                    } else if (holding.assetClass === 'bonds') {
                        coreBonds += value;
                    } else if (holding.assetClass === 'cash') {
                        coreCash += value;
                    }
                }
            });
            
            return {coreTotal, coreEquity, coreBonds, coreCash};
        }
        
        // Edit core holdings
        function editCoreHoldings() {
            coreEditMode = true;
            document.getElementById('coreEditMode').style.display = 'block';
            renderCoreTable();
        }
        
        function exitEditMode() {
            coreEditMode = false;
            document.getElementById('coreEditMode').style.display = 'none';
            renderCoreTable();
        }
        
        // Save core holdings configuration
        function saveCoreHoldings() {
            localStorage.setItem('coreHoldings', JSON.stringify(coreHoldings));
            alert('‚úì Core holdings configuration saved!');
        }
        
        // Load core holdings configuration
        function loadCoreHoldings() {
            const saved = localStorage.getItem('coreHoldings');
            if (saved) {
                const savedHoldings = JSON.parse(saved);
                // Merge saved data with defaults, preserving targetPct if not saved
                Object.keys(coreHoldings).forEach(key => {
                    if (savedHoldings[key]) {
                        // Preserve targetPct default if not in saved data
                        const defaultTargetPct = coreHoldings[key].targetPct;
                        coreHoldings[key] = {...savedHoldings[key]};
                        if (!coreHoldings[key].targetPct) {
                            coreHoldings[key].targetPct = defaultTargetPct;
                        }
                    }
                });
            }
        }
        
        // Update core ticker
        function updateCoreTicker(coreId, newTicker) {
            newTicker = newTicker.toUpperCase().trim();
            if (newTicker) {
                coreHoldings[coreId].ticker = newTicker;
                renderCoreTable();
            }
        }
        
        // Update core name
        function updateCoreName(coreId, newName) {
            if (newName) {
                coreHoldings[coreId].name = newName;
                renderCoreTable();
            }
        }
        
        // Render core table
        function renderCoreTable() {
            // Store current values before re-rendering
            const currentValues = {};
            const currentTargets = {};
            
            Object.values(coreHoldings).forEach(holding => {
                const ticker = holding.ticker.toLowerCase();
                const valueInput = document.getElementById('core_' + ticker);
                const targetInput = document.getElementById('target_' + ticker);
                
                if (valueInput) currentValues[ticker] = valueInput.value;
                if (targetInput) currentTargets[ticker] = targetInput.value;
            });
            
            let html = '';
            
            Object.entries(coreHoldings).forEach(([coreId, holding]) => {
                const ticker = holding.ticker.toLowerCase();
                
                // Get stored values or use defaults
                const currentValue = currentValues[ticker] || '0';
                const targetPct = currentTargets[ticker] || holding.targetPct || '0';
                
                html += '<tr>';
                
                // Ticker column - editable in edit mode
                if (coreEditMode) {
                    html += '<td><input type="text" value="' + holding.ticker + '" style="width: 100px; text-transform: uppercase;" onchange="updateCoreTicker(\'' + coreId + '\', this.value)"></td>';
                } else {
                    html += '<td><strong>' + holding.ticker + '</strong></td>';
                }
                
                // Asset Class column - editable in edit mode
                if (coreEditMode) {
                    html += '<td><input type="text" value="' + holding.name + '" style="width: 150px;" onchange="updateCoreName(\'' + coreId + '\', this.value)"></td>';
                } else {
                    html += '<td>' + holding.name + '</td>';
                }
                
                // Shares column
                html += '<td><input type="number" value="' + (holding.shares || 0) + '" step="0.01" style="width: 100px;" onchange="updateCoreShares(\'' + coreId + '\', this.value)"></td>';
                
                // Current Value column
                html += '<td><input type="number" id="core_' + ticker + '" value="' + currentValue + '" step="0.01" style="width: 120px;" onchange="calculateRebalance()"></td>';
                
                // Yield column
                html += '<td><input type="number" value="' + (holding.yield || 0) + '" step="0.01" style="width: 80px;" onchange="updateCoreYield(\'' + coreId + '\', this.value)"></td>';
                
                // Current % column
                html += '<td id="core_' + ticker + '_pct">0%</td>';
                
                // Target % column
                html += '<td><input type="number" id="target_' + ticker + '" value="' + targetPct + '" step="1" style="width: 80px;" onchange="calculateRebalance()"></td>';
                
                // Target Value column
                html += '<td id="target_' + ticker + '_val">$0</td>';
                
                // Action column
                html += '<td id="action_' + ticker + '"></td>';
                
                html += '</tr>';
            });
            
            document.getElementById('coreHoldings').innerHTML = html;
            
            // Now recalculate with the rendered inputs
            setTimeout(() => calculateRebalance(), 100);
            renderHoldingsSummary();
        }
        
        // Update core shares
        function updateCoreShares(coreId, shares) {
            coreHoldings[coreId].shares = parseFloat(shares) || 0;
            syncShareCounts();
        }
        
        // Update core yield
        function updateCoreYield(coreId, yieldPct) {
            coreHoldings[coreId].yield = parseFloat(yieldPct) || 0;
        }
        
        // Show/hide add holding form
        function showAddHoldingForm() {
            document.getElementById('addHoldingForm').style.display = 'block';
        }
        
        function hideAddHoldingForm() {
            document.getElementById('addHoldingForm').style.display = 'none';
            document.getElementById('new_ticker').value = '';
            document.getElementById('new_value').value = '';
            document.getElementById('new_sector').value = '';
        }
        
        // Add new holding
        function addHolding() {
            const ticker = document.getElementById('new_ticker').value.toUpperCase().trim();
            const value = parseFloat(document.getElementById('new_value').value);
            const sector = document.getElementById('new_sector').value;
            
            if (!ticker || !value || !sector) {
                alert('Please fill in all fields');
                return;
            }
            
            if (dividendHoldings[ticker]) {
                alert('This ticker already exists. Edit the existing holding instead.');
                return;
            }
            
            dividendHoldings[ticker] = {value: value, sector: sector};
            hideAddHoldingForm();
            updateDividendView();
            updateOverallAllocation();
        }
        
        // Remove holding
        function removeHolding(ticker) {
            if (confirm('Are you sure you want to remove ' + ticker + '?')) {
                delete dividendHoldings[ticker];
                updateDividendView();
                updateOverallAllocation();
            }
        }
        
        // Update holding value
        function updateHoldingValue(ticker, newValue) {
            if (dividendHoldings[ticker]) {
                dividendHoldings[ticker].value = parseFloat(newValue) || 0;
                updateDividendView();
                updateOverallAllocation();
            }
        }
        
        // Update free cash
        function updateFreeCash() {
            freeCash = parseFloat(document.getElementById('freeCashInput').value) || 0;
            updateDividendView();
            updateOverallAllocation();
        }
        
        // Save dividend holdings to localStorage
        function saveDividendHoldings() {
            localStorage.setItem('dividendHoldings', JSON.stringify(dividendHoldings));
            localStorage.setItem('freeCash', freeCash);
            alert('‚úì Holdings saved successfully!');
        }
        
        // Load dividend holdings from localStorage
        function loadDividendHoldings() {
            const saved = localStorage.getItem('dividendHoldings');
            const savedCash = localStorage.getItem('freeCash');
            
            if (saved) {
                dividendHoldings = JSON.parse(saved);
            }
            if (savedCash) {
                freeCash = parseFloat(savedCash);
            }
            
            document.getElementById('freeCashInput').value = freeCash;
        }
        
        // ==================== DIVIDEND TRACKER FUNCTIONS ====================
        
        // Show/hide dividend form
        function showAddDividendForm() {
            // Populate ticker dropdown
            const select = document.getElementById('div_ticker');
            select.innerHTML = '<option value="">Select ticker...</option>';
            
            // Add core holdings
            Object.values(coreHoldings).forEach(h => {
                select.innerHTML += '<option value="' + h.ticker + '">' + h.ticker + '</option>';
            });
            
            // Add dividend holdings
            Object.keys(dividendHoldings).forEach(ticker => {
                select.innerHTML += '<option value="' + ticker + '">' + ticker + '</option>';
            });
            
            document.getElementById('addDividendForm').style.display = 'block';
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('div_date').value = today;
        }
        
        function hideAddDividendForm() {
            document.getElementById('addDividendForm').style.display = 'none';
            document.getElementById('div_ticker').value = '';
            document.getElementById('div_date').value = '';
            document.getElementById('div_amount').value = '';
        }
        
        // Add dividend payment
        function addDividendPayment() {
            const ticker = document.getElementById('div_ticker').value;
            const date = document.getElementById('div_date').value;
            const amount = parseFloat(document.getElementById('div_amount').value);
            
            if (!ticker || !date || !amount) {
                alert('Please fill in all fields');
                return;
            }
            
            dividendPayments.push({
                ticker: ticker,
                date: date,
                amount: amount,
                id: Date.now()
            });
            
            hideAddDividendForm();
            updateDividendTracker();
        }
        
        // Remove dividend payment
        function removeDividendPayment(id) {
            if (confirm('Remove this dividend payment?')) {
                dividendPayments = dividendPayments.filter(d => d.id !== id);
                updateDividendTracker();
            }
        }
        
        // Update dividend tracker display
        function updateDividendTracker() {
            const now = new Date();
            const thisYear = now.getFullYear();
            const twelveMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 12, now.getDate());
            
            // Calculate totals
            let totalAll = 0;
            let totalYear = 0;
            let total12Mo = 0;
            
            dividendPayments.forEach(payment => {
                const paymentDate = new Date(payment.date);
                totalAll += payment.amount;
                
                if (paymentDate.getFullYear() === thisYear) {
                    totalYear += payment.amount;
                }
                
                if (paymentDate >= twelveMonthsAgo) {
                    total12Mo += payment.amount;
                }
            });
            
            // Calculate estimated annual income from yields
            let estimatedAnnual = 0;
            
            // From dividend holdings
            Object.values(dividendHoldings).forEach(h => {
                if (h.yield && h.value) {
                    estimatedAnnual += h.value * (h.yield / 100);
                }
            });
            
            // From core holdings
            Object.values(coreHoldings).forEach(h => {
                if (h.yield) {
                    const ticker = h.ticker.toLowerCase();
                    const value = parseFloat(document.getElementById('core_' + ticker)?.value) || 0;
                    estimatedAnnual += value * (h.yield / 100);
                }
            });
            
            // Update summary cards
            document.getElementById('total_dividends_all').textContent = formatCurrency(totalAll);
            document.getElementById('total_dividends_year').textContent = formatCurrency(totalYear);
            document.getElementById('total_dividends_12mo').textContent = formatCurrency(total12Mo);
            document.getElementById('projected_annual').textContent = formatCurrency(estimatedAnnual);
            
            // Update history table
            let historyHtml = '';
            const sortedPayments = [...dividendPayments].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (sortedPayments.length === 0) {
                historyHtml = '<tr><td colspan="4" style="text-align: center; color: #6c757d;">No dividend payments logged yet</td></tr>';
            } else {
                sortedPayments.forEach(payment => {
                    historyHtml += '<tr>';
                    historyHtml += '<td>' + payment.date + '</td>';
                    historyHtml += '<td><strong>' + payment.ticker + '</strong></td>';
                    historyHtml += '<td>' + formatCurrency(payment.amount) + '</td>';
                    historyHtml += '<td><button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.85em;" onclick="removeDividendPayment(' + payment.id + ')">Delete</button></td>';
                    historyHtml += '</tr>';
                });
            }
            document.getElementById('dividendHistory').innerHTML = historyHtml;
            
            // Update by holding table - include estimated annual
            const byHolding = {};
            dividendPayments.forEach(payment => {
                if (!byHolding[payment.ticker]) {
                    byHolding[payment.ticker] = {total: 0, last12mo: 0, count: 0};
                }
                
                const paymentDate = new Date(payment.date);
                byHolding[payment.ticker].total += payment.amount;
                byHolding[payment.ticker].count++;
                
                if (paymentDate >= twelveMonthsAgo) {
                    byHolding[payment.ticker].last12mo += payment.amount;
                }
            });
            
            let byHoldingHtml = '';
            Object.entries(byHolding).sort((a, b) => b[1].total - a[1].total).forEach(([ticker, data]) => {
                byHoldingHtml += '<tr>';
                byHoldingHtml += '<td><strong>' + ticker + '</strong></td>';
                byHoldingHtml += '<td>' + formatCurrency(data.total) + '</td>';
                byHoldingHtml += '<td>' + formatCurrency(data.last12mo) + '</td>';
                byHoldingHtml += '<td>' + data.count + '</td>';
                byHoldingHtml += '</tr>';
            });
            
            if (!byHoldingHtml) {
                byHoldingHtml = '<tr><td colspan="4" style="text-align: center; color: #6c757d;">No data yet</td></tr>';
            }
            
            document.getElementById('dividendByHolding').innerHTML = byHoldingHtml;
        }
        
        // Save dividend payments
        function saveDividendPayments() {
            localStorage.setItem('dividendPayments', JSON.stringify(dividendPayments));
            alert('‚úì Dividend data saved!');
        }
        
        // Load dividend payments
        function loadDividendPayments() {
            const saved = localStorage.getItem('dividendPayments');
            if (saved) {
                dividendPayments = JSON.parse(saved);
            }
        }
        
        // Save share counts
        function saveShareCounts() {
            localStorage.setItem('shareCounts', JSON.stringify(shareCounts));
            localStorage.setItem('lastPrices', JSON.stringify(lastPrices));
            alert('‚úì Share counts saved!');
        }
        
        // Load share counts
        function loadShareCounts() {
            const savedCounts = localStorage.getItem('shareCounts');
            const savedPrices = localStorage.getItem('lastPrices');
            
            if (savedCounts) {
                shareCounts = JSON.parse(savedCounts);
            }
            if (savedPrices) {
                lastPrices = JSON.parse(savedPrices);
            }
        }
        
        // Render holdings summary tables
        function renderHoldingsSummary() {
            // Sync first to make sure we have latest data
            syncShareCounts();
            
            // Core holdings summary
            let coreHtml = '';
            let coreTotalValue = 0;
            let coreTotalIncome = 0;
            
            Object.values(coreHoldings).forEach(holding => {
                const ticker = holding.ticker;
                const shares = holding.shares || 0;
                const value = parseFloat(document.getElementById('core_' + ticker.toLowerCase())?.value) || 0;
                const yieldPct = holding.yield || 0;
                const annualIncome = value * (yieldPct / 100);
                
                coreTotalValue += value;
                coreTotalIncome += annualIncome;
                
                coreHtml += '<tr>';
                coreHtml += '<td><strong>' + ticker + '</strong></td>';
                coreHtml += '<td>' + shares.toFixed(2) + '</td>';
                coreHtml += '<td>' + formatCurrency(value) + '</td>';
                coreHtml += '<td>' + yieldPct.toFixed(2) + '%</td>';
                coreHtml += '<td>' + formatCurrency(annualIncome) + '</td>';
                coreHtml += '</tr>';
            });
            
            if (!coreHtml) {
                coreHtml = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">No data entered yet</td></tr>';
            }
            
            document.getElementById('coreHoldingsSummary').innerHTML = coreHtml;
            
            // Dividend holdings summary
            let divHtml = '';
            let divTotalValue = 0;
            let divTotalIncome = 0;
            
            Object.entries(dividendHoldings).forEach(([ticker, data]) => {
                const shares = data.shares || 0;
                const value = data.value || 0;
                const yieldPct = data.yield || 0;
                const annualIncome = value * (yieldPct / 100);
                
                divTotalValue += value;
                divTotalIncome += annualIncome;
                
                divHtml += '<tr>';
                divHtml += '<td><strong>' + ticker + '</strong></td>';
                divHtml += '<td>' + shares.toFixed(2) + '</td>';
                divHtml += '<td>' + formatCurrency(value) + '</td>';
                divHtml += '<td>' + yieldPct.toFixed(2) + '%</td>';
                divHtml += '<td>' + formatCurrency(annualIncome) + '</td>';
                divHtml += '</tr>';
            });
            
            if (!divHtml) {
                divHtml = '<tr><td colspan="5" style="text-align: center; color: #6c757d;">No data entered yet</td></tr>';
            }
            
            document.getElementById('dividendHoldingsSummary').innerHTML = divHtml;
            
            // Update totals
            const totalValue = coreTotalValue + divTotalValue + freeCash;
            const totalIncome = coreTotalIncome + divTotalIncome;
            const avgYield = totalValue > 0 ? (totalIncome / totalValue) * 100 : 0;
            const monthlyIncome = totalIncome / 12;
            
            document.getElementById('summary_total_value').textContent = formatCurrency(totalValue);
            document.getElementById('avg_yield').textContent = formatPercent(avgYield);
            document.getElementById('summary_annual_income').textContent = formatCurrency(totalIncome);
            document.getElementById('monthly_income').textContent = formatCurrency(monthlyIncome);
        }
        
        // Update all prices via API
        async function updateAllPrices() {
            const statusDiv = document.getElementById('priceUpdateStatus');
            statusDiv.innerHTML = '<div class="alert alert-info">üîÑ Fetching prices... This may take 20-30 seconds.<br>Processing...</div>';
            
            const allTickers = [
                ...Object.values(coreHoldings).map(h => h.ticker),
                ...Object.keys(dividendHoldings)
            ];
            
            let successCount = 0;
            let errorCount = 0;
            let errors = [];
            let processLog = [];
            
            for (const ticker of allTickers) {
                try {
                    processLog.push('Trying ' + ticker + '...');
                    
                    // Try Yahoo Finance quote endpoint first
                    let response = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${ticker}`);
                    let data = await response.json();
                    
                    let price = null;
                    
                    // Try to get price from quote endpoint
                    if (data?.quoteResponse?.result?.[0]?.regularMarketPrice) {
                        price = parseFloat(data.quoteResponse.result[0].regularMarketPrice);
                    }
                    
                    // If that failed, try the chart endpoint
                    if (!price) {
                        response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`);
                        data = await response.json();
                        
                        if (data?.chart?.result?.[0]?.meta?.regularMarketPrice) {
                            price = parseFloat(data.chart.result[0].meta.regularMarketPrice);
                        }
                    }
                    
                    if (price && price > 0) {
                        lastPrices[ticker] = {
                            price: price,
                            timestamp: new Date().toLocaleString()
                        };
                        
                        // Update value in holdings if shares are set
                        const shares = shareCounts[ticker];
                        if (shares && shares > 0) {
                            const value = shares * price;
                            
                            // Update core holdings
                            const coreInput = document.getElementById('core_' + ticker.toLowerCase());
                            if (coreInput) {
                                coreInput.value = value.toFixed(2);
                            }
                            
                            // Update dividend holdings
                            if (dividendHoldings[ticker]) {
                                dividendHoldings[ticker].value = value;
                            }
                        }
                        
                        processLog.push('‚úì ' + ticker + ': $' + price.toFixed(2));
                        successCount++;
                    } else {
                        processLog.push('‚úó ' + ticker + ': No price found');
                        errorCount++;
                        errors.push(ticker + ' (no price data)');
                    }
                    
                    // Update status live
                    statusDiv.innerHTML = '<div class="alert alert-info">üîÑ Processing... ' + (successCount + errorCount) + '/' + allTickers.length + '<br>' +
                        'Success: ' + successCount + ' | Failed: ' + errorCount + '</div>';
                    
                    // Small delay to be nice to the server
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                } catch (error) {
                    console.error('Error fetching ' + ticker, error);
                    errorCount++;
                    errors.push(ticker + ' (error: ' + error.message + ')');
                    processLog.push('‚úó ' + ticker + ': ' + error.message);
                }
            }
            
            renderShareCountTables();
            updateDividendView();
            calculateRebalance();
            updateOverview();
            updateOverallAllocation();
            
            let statusHtml = '<div class="alert ' + (errorCount > 0 ? 'alert-warning' : 'alert-success') + '">';
            statusHtml += '‚úì Price update complete!<br>';
            statusHtml += 'Successfully updated: <strong>' + successCount + '</strong> securities<br>';
            
            if (errorCount > 0) {
                statusHtml += 'Failed: <strong>' + errorCount + '</strong> securities<br>';
                statusHtml += '<br><strong>Failed tickers:</strong><br>';
                errors.forEach(err => {
                    statusHtml += '‚Ä¢ ' + err + '<br>';
                });
            }
            
            if (successCount === 0) {
                statusHtml += '<br><strong>‚ö†Ô∏è No prices were updated!</strong><br>';
                statusHtml += 'This could be because:<br>';
                statusHtml += '1. You haven\'t entered share counts in Core Rebalancing or Dividend Holdings tabs<br>';
                statusHtml += '2. Ticker symbols are incorrect<br>';
                statusHtml += '3. Your browser is blocking the requests (try a different browser)<br>';
                statusHtml += '4. Yahoo Finance is temporarily unavailable<br>';
            }
            
            statusHtml += '<br><br><details><summary>Show detailed log (click to expand)</summary><pre style="font-size: 0.8em; max-height: 300px; overflow-y: auto;">';
            statusHtml += processLog.join('\n');
            statusHtml += '</pre></details>';
            
            statusHtml += '</div>';
            
            statusDiv.innerHTML = statusHtml;
        }
        
        // Tab switching
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'overview') updateOverview();
            if (tabName === 'overall') updateOverallAllocation();
            if (tabName === 'rebalance') calculateRebalance();
            if (tabName === 'dividend') updateDividendView();
            if (tabName === 'dividendtracker') updateDividendTracker();
            if (tabName === 'prices') renderHoldingsSummary();
            if (tabName === 'cashflow') updateCashFlow();
        }
        
        // Set allocation strategy
        function setAllocation(strategy) {
            const strategies = {
                'conservative': {
                    name: 'Conservative (40/60)',
                    equity: 40,
                    bonds: 50,
                    cash: 10,
                    targets: {
                        swppx: 26,  // US: 26%
                        vwo: 5,     // EM: 5%
                        schf: 9,    // Intl: 9%
                        bnd: 50,    // Bonds: 50%
                        scho: 10    // Cash: 10%
                    }
                },
                'moderate': {
                    name: 'Moderate (65/35)',
                    equity: 65,
                    bonds: 30,
                    cash: 5,
                    targets: {
                        swppx: 42,  // US: 42%
                        vwo: 8,     // EM: 8%
                        schf: 15,   // Intl: 15%
                        bnd: 30,    // Bonds: 30%
                        scho: 5     // Cash: 5%
                    }
                },
                'mod-aggressive': {
                    name: 'Moderately Aggressive (75/25)',
                    equity: 75,
                    bonds: 20,
                    cash: 5,
                    targets: {
                        swppx: 48,  // US: 48%
                        vwo: 9,     // EM: 9%
                        schf: 18,   // Intl: 18%
                        bnd: 20,    // Bonds: 20%
                        scho: 5     // Cash: 5%
                    }
                },
                'aggressive': {
                    name: 'Aggressive (90/10)',
                    equity: 90,
                    bonds: 7,
                    cash: 3,
                    targets: {
                        swppx: 58,  // US: 58%
                        vwo: 11,    // EM: 11%
                        schf: 21,   // Intl: 21%
                        bnd: 7,     // Bonds: 7%
                        scho: 3     // Cash: 3%
                    }
                }
            };
            
            const selected = strategies[strategy];
            if (!selected) return;
            
            // Update target inputs
            Object.entries(selected.targets).forEach(([ticker, target]) => {
                const input = document.getElementById('target_' + ticker);
                if (input) {
                    input.value = target;
                }
            });
            
            // Update info message
            document.getElementById('allocationInfo').innerHTML = 
                '<strong>Current Strategy: ' + selected.name + '</strong><br>' +
                selected.equity + '% Stocks / ' + (selected.bonds + selected.cash) + '% Bonds+Cash';
            
            // Recalculate
            calculateRebalance();
        }
        
        // Format currency
        function formatCurrency(amount) {
            return '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Format percentage
        function formatPercent(percent) {
            return percent.toFixed(1) + '%';
        }
        
        // Calculate core rebalancing
        function calculateRebalance() {
            const tickers = Object.values(coreHoldings).map(h => h.ticker.toLowerCase());
            let totalValue = 0;
            let totalTargetPct = 0;
            
            // Calculate total value and total target percentage
            tickers.forEach(ticker => {
                const value = parseFloat(document.getElementById('core_' + ticker).value) || 0;
                totalValue += value;
                const targetPct = parseFloat(document.getElementById('target_' + ticker).value) || 0;
                totalTargetPct += targetPct;
            });
            
            // Validate target percentages
            const validationDiv = document.getElementById('targetValidation');
            if (Math.abs(totalTargetPct - 100) > 0.1) {
                validationDiv.innerHTML = '<div class="alert alert-warning">' +
                    '‚ö†Ô∏è <strong>Target percentages do not equal 100%!</strong><br>' +
                    'Current total: <strong>' + totalTargetPct.toFixed(1) + '%</strong><br>' +
                    'Difference: <strong>' + (totalTargetPct - 100).toFixed(1) + '%</strong><br>' +
                    'Click "Auto-Adjust to 100%" to automatically fix this, or manually adjust your targets.' +
                    '</div>';
            } else {
                validationDiv.innerHTML = '<div class="alert alert-success">' +
                    '‚úì Target percentages total: <strong>100%</strong>' +
                    '</div>';
            }
            
            let sellActions = [];
            let buyActions = [];
            let totalSell = 0;
            let totalBuy = 0;
            
            // Calculate for each holding
            tickers.forEach(ticker => {
                const currentValue = parseFloat(document.getElementById('core_' + ticker).value) || 0;
                const targetPct = parseFloat(document.getElementById('target_' + ticker).value) || 0;
                const targetValue = totalValue * (targetPct / 100);
                const difference = targetValue - currentValue;
                
                const currentPct = (currentValue / totalValue) * 100;
                
                document.getElementById('core_' + ticker + '_pct').textContent = formatPercent(currentPct);
                document.getElementById('target_' + ticker + '_val').textContent = formatCurrency(targetValue);
                
                if (Math.abs(difference) < 0.01) {
                    document.getElementById('action_' + ticker).textContent = 'Hold';
                } else if (difference > 0) {
                    document.getElementById('action_' + ticker).innerHTML = '<span class="action-buy">BUY ' + formatCurrency(difference) + '</span>';
                    buyActions.push({ticker: ticker.toUpperCase(), amount: difference});
                    totalBuy += difference;
                } else {
                    document.getElementById('action_' + ticker).innerHTML = '<span class="action-sell">SELL ' + formatCurrency(Math.abs(difference)) + '</span>';
                    sellActions.push({ticker: ticker.toUpperCase(), amount: Math.abs(difference)});
                    totalSell += Math.abs(difference);
                }
            });
            
            // Show results
            const resultsDiv = document.getElementById('rebalanceResults');
            const actionsDiv = document.getElementById('rebalanceActions');
            
            if (sellActions.length > 0 || buyActions.length > 0) {
                let html = '<div class="grid">';
                
                if (sellActions.length > 0) {
                    html += '<div>';
                    html += '<h3>SELL Actions</h3>';
                    sellActions.forEach(action => {
                        html += '<div class="alert alert-warning">SELL ' + action.ticker + ': ' + formatCurrency(action.amount) + '</div>';
                    });
                    html += '<p><strong>Total Proceeds: ' + formatCurrency(totalSell) + '</strong></p>';
                    html += '</div>';
                }
                
                if (buyActions.length > 0) {
                    html += '<div>';
                    html += '<h3>BUY Actions</h3>';
                    buyActions.forEach(action => {
                        html += '<div class="alert alert-success">BUY ' + action.ticker + ': ' + formatCurrency(action.amount) + '</div>';
                    });
                    html += '<p><strong>Total Investment: ' + formatCurrency(totalBuy) + '</strong></p>';
                    html += '</div>';
                }
                
                html += '</div>';
                actionsDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.style.display = 'none';
            }
        }
        
        // Auto-adjust targets to equal 100%
        function autoAdjustTargets() {
            const tickers = Object.values(coreHoldings).map(h => h.ticker.toLowerCase());
            let totalTargetPct = 0;
            
            // Get current total
            tickers.forEach(ticker => {
                const targetPct = parseFloat(document.getElementById('target_' + ticker).value) || 0;
                totalTargetPct += targetPct;
            });
            
            if (Math.abs(totalTargetPct - 100) < 0.1) {
                alert('Targets are already at 100%!');
                return;
            }
            
            // Calculate adjustment factor
            const adjustmentFactor = 100 / totalTargetPct;
            
            // Apply proportional adjustment to each holding
            tickers.forEach(ticker => {
                const currentTarget = parseFloat(document.getElementById('target_' + ticker).value) || 0;
                const newTarget = currentTarget * adjustmentFactor;
                document.getElementById('target_' + ticker).value = newTarget.toFixed(1);
            });
            
            // Recalculate
            calculateRebalance();
            alert('‚úì Targets adjusted to equal 100%!');
        }
        
        // Update dividend view
        function updateDividendView() {
            let totalDividend = freeCash;
            Object.values(dividendHoldings).forEach(h => totalDividend += h.value);
            
            // Update holdings table with shares and yield
            let html = '';
            const sortedHoldings = Object.entries(dividendHoldings).sort((a, b) => b[1].value - a[1].value);
            
            sortedHoldings.forEach(([ticker, data]) => {
                const pct = (data.value / totalDividend) * 100;
                html += '<tr>';
                html += '<td><strong>' + ticker + '</strong></td>';
                html += '<td>' + data.sector + '</td>';
                html += '<td><input type="number" value="' + (data.shares || 0) + '" step="0.01" style="width: 100px;" onchange="updateDividendShares(\'' + ticker + '\', this.value)"></td>';
                html += '<td><input type="number" value="' + data.value.toFixed(2) + '" step="0.01" style="width: 120px;" onchange="updateHoldingValue(\'' + ticker + '\', this.value)"></td>';
                html += '<td><input type="number" value="' + (data.yield || 0) + '" step="0.01" style="width: 80px;" onchange="updateDividendYield(\'' + ticker + '\', this.value)"></td>';
                html += '<td>' + formatPercent(pct) + '</td>';
                html += '<td><button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.85em;" onclick="removeHolding(\'' + ticker + '\')">Delete</button></td>';
                html += '</tr>';
            });
            
            document.getElementById('dividendHoldings').innerHTML = html;
            
            // Sync share counts to price update tab
            syncShareCounts();
            renderHoldingsSummary();
            
            // Calculate sector totals
            const sectors = {};
            Object.entries(dividendHoldings).forEach(([ticker, data]) => {
                if (!sectors[data.sector]) sectors[data.sector] = 0;
                sectors[data.sector] += data.value;
            });
            sectors['Cash'] = (sectors['Cash'] || 0) + freeCash;
            
            // Update sector monitor
            let sectorHtml = '';
            const sortedSectors = Object.entries(sectors).sort((a, b) => b[1] - a[1]);
            
            sortedSectors.forEach(([sector, value]) => {
                const pct = (value / totalDividend) * 100;
                const isOver = pct > 30;
                
                sectorHtml += '<div style="margin-bottom: 20px;">';
                sectorHtml += '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">';
                sectorHtml += '<strong>' + sector + '</strong>';
                sectorHtml += '<span>' + formatCurrency(value) + ' (' + formatPercent(pct) + ')</span>';
                sectorHtml += '</div>';
                sectorHtml += '<div class="progress-bar">';
                sectorHtml += '<div class="progress-fill ' + (isOver ? 'over-limit' : '') + '" style="width: ' + Math.min(pct / 30 * 100, 100) + '%">';
                sectorHtml += formatPercent(pct);
                sectorHtml += '</div>';
                sectorHtml += '</div>';
                if (isOver) {
                    sectorHtml += '<div class="alert alert-warning" style="margin-top: 10px;">‚ö†Ô∏è Over 30% limit!</div>';
                }
                sectorHtml += '</div>';
            });
            
            document.getElementById('sectorMonitor').innerHTML = sectorHtml;
            
            // Update headroom table
            let headroomHtml = '';
            const maxAllowed = totalDividend * 0.30;
            
            sortedSectors.forEach(([sector, value]) => {
                const pct = (value / totalDividend) * 100;
                const headroom = maxAllowed - value;
                const isOver = pct > 30;
                
                headroomHtml += '<tr>';
                headroomHtml += '<td>' + sector + '</td>';
                headroomHtml += '<td>' + formatPercent(pct) + '</td>';
                if (isOver) {
                    headroomHtml += '<td style="color: #dc3545;">Over by ' + formatCurrency(Math.abs(headroom)) + '</td>';
                    headroomHtml += '<td><span style="background: #dc3545; color: white; padding: 5px 10px; border-radius: 5px;">OVER LIMIT</span></td>';
                } else {
                    headroomHtml += '<td style="color: #28a745;">' + formatCurrency(headroom) + '</td>';
                    headroomHtml += '<td><span style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px;">OK</span></td>';
                }
                headroomHtml += '</tr>';
            });
            
            document.getElementById('headroomTable').innerHTML = headroomHtml;
        }
        
        // Update dividend shares
        function updateDividendShares(ticker, shares) {
            if (dividendHoldings[ticker]) {
                dividendHoldings[ticker].shares = parseFloat(shares) || 0;
                syncShareCounts();
            }
        }
        
        // Update dividend yield
        function updateDividendYield(ticker, yieldPct) {
            if (dividendHoldings[ticker]) {
                dividendHoldings[ticker].yield = parseFloat(yieldPct) || 0;
            }
        }
        
        // Sync share counts between dividend holdings and price update tab
        function syncShareCounts() {
            // Sync from dividend holdings
            Object.entries(dividendHoldings).forEach(([ticker, data]) => {
                if (data.shares) {
                    shareCounts[ticker] = data.shares;
                }
            });
            
            // Sync from core holdings
            Object.values(coreHoldings).forEach(holding => {
                if (holding.shares) {
                    shareCounts[holding.ticker] = holding.shares;
                }
            });
        }
        
        // Update overview
        function updateOverview() {
            // Get core values dynamically
            const {coreTotal, coreEquity, coreBonds, coreCash} = getCoreAssetBreakdown();
            
            // Get dividend values
            let dividendEquity = 0;
            let dividendCash = 0;
            
            Object.values(dividendHoldings).forEach(h => {
                if (h.sector === 'Cash') {
                    dividendCash += h.value;
                } else {
                    dividendEquity += h.value;
                }
            });
            dividendCash += freeCash;
            
            const totalValue = coreTotal + Object.values(dividendHoldings).reduce((sum, h) => sum + h.value, 0) + freeCash;
            const totalEquity = coreEquity + dividendEquity;
            const totalBonds = coreBonds;
            const totalCash = coreCash + dividendCash;
            
            const equityPct = (totalEquity / totalValue) * 100;
            const bondsPct = (totalBonds / totalValue) * 100;
            const cashPct = (totalCash / totalValue) * 100;
            
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalEquity').textContent = formatPercent(equityPct);
            document.getElementById('totalBonds').textContent = formatPercent(bondsPct);
            document.getElementById('totalCash').textContent = formatPercent(cashPct);
            
            // Overall allocation display
            let allocHtml = '<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">';
            allocHtml += '<h3>Overall: ' + formatPercent(equityPct) + ' Equity / ' + formatPercent(bondsPct + cashPct) + ' Bonds+Cash</h3>';
            allocHtml += '</div>';
            
            const classifications = [
                {name: 'Conservative', min: 40, max: 50},
                {name: 'Moderate', min: 60, max: 70},
                {name: 'Moderately Aggressive', min: 70, max: 85},
                {name: 'Aggressive', min: 85, max: 100}
            ];
            
            let classification = 'Between Moderate and Moderately Aggressive';
            classifications.forEach(c => {
                if (equityPct >= c.min && equityPct < c.max) {
                    classification = c.name;
                }
            });
            
            allocHtml += '<div class="alert alert-info">';
            allocHtml += '<strong>Portfolio Classification: ' + classification + '</strong>';
            allocHtml += '</div>';
            
            document.getElementById('overallAllocation').innerHTML = allocHtml;
            
            // Asset breakdown
            let breakdownHtml = '';
            const breakdown = [
                {name: 'Total Equity', value: totalEquity, pct: equityPct},
                {name: 'Total Bonds', value: totalBonds, pct: bondsPct},
                {name: 'Total Cash', value: totalCash, pct: cashPct}
            ];
            
            breakdown.forEach(item => {
                breakdownHtml += '<tr>';
                breakdownHtml += '<td><strong>' + item.name + '</strong></td>';
                breakdownHtml += '<td>' + formatCurrency(item.value) + '</td>';
                breakdownHtml += '<td>' + formatPercent(item.pct) + '</td>';
                breakdownHtml += '<td><div class="progress-bar"><div class="progress-fill" style="width: ' + item.pct + '%">' + formatPercent(item.pct) + '</div></div></td>';
                breakdownHtml += '</tr>';
            });
            
            document.getElementById('assetBreakdown').innerHTML = breakdownHtml;
        }
        
        // Update overall allocation tab
        function updateOverallAllocation() {
            // Get core values using helper
            const {coreTotal, coreEquity, coreBonds, coreCash} = getCoreAssetBreakdown();
            
            // Get dividend values
            let dividendEquity = 0;
            let dividendCash = 0;
            
            Object.values(dividendHoldings).forEach(h => {
                if (h.sector === 'Cash') {
                    dividendCash += h.value;
                } else {
                    dividendEquity += h.value;
                }
            });
            dividendCash += freeCash;
            
            const totalValue = coreTotal + Object.values(dividendHoldings).reduce((sum, h) => sum + h.value, 0) + freeCash;
            const totalEquity = coreEquity + dividendEquity;
            const totalBonds = coreBonds;
            const totalCash = coreCash + dividendCash;
            
            const equityPct = (totalEquity / totalValue) * 100;
            const bondsPct = (totalBonds / totalValue) * 100;
            const cashPct = (totalCash / totalValue) * 100;
            
            // Update main stats
            document.getElementById('overall_total').textContent = formatCurrency(totalValue);
            document.getElementById('overall_equity_pct').textContent = formatPercent(equityPct);
            document.getElementById('overall_bonds_pct').textContent = formatPercent(bondsPct);
            document.getElementById('overall_cash_pct').textContent = formatPercent(cashPct);
            
            // Classification
            const classifications = [
                {name: 'Conservative', min: 40, max: 60, equity: 50},
                {name: 'Moderate', min: 60, max: 70, equity: 65},
                {name: 'Moderately Aggressive', min: 70, max: 85, equity: 75},
                {name: 'Aggressive', min: 85, max: 100, equity: 90}
            ];
            
            let currentClassification = 'Custom';
            let classColor = '#17a2b8';
            
            classifications.forEach(c => {
                if (equityPct >= c.min && equityPct < c.max) {
                    currentClassification = c.name;
                    classColor = '#28a745';
                }
            });
            
            let classHtml = '<div class="alert alert-info" style="border-left-color: ' + classColor + ';">';
            classHtml += '<strong>Your Portfolio Classification: ' + currentClassification + '</strong><br>';
            classHtml += formatPercent(equityPct) + ' Equity / ' + formatPercent(bondsPct + cashPct) + ' Bonds+Cash';
            classHtml += '</div>';
            
            document.getElementById('overall_classification').innerHTML = classHtml;
            
            // Breakdown by source
            let breakdownHtml = '';
            breakdownHtml += '<tr>';
            breakdownHtml += '<td><strong>Core Holdings</strong></td>';
            breakdownHtml += '<td>' + formatCurrency(coreTotal) + '</td>';
            breakdownHtml += '<td>' + formatCurrency(coreEquity) + ' (' + formatPercent((coreEquity/coreTotal)*100) + ')</td>';
            breakdownHtml += '<td>' + formatCurrency(coreBonds) + ' (' + formatPercent((coreBonds/coreTotal)*100) + ')</td>';
            breakdownHtml += '<td>' + formatCurrency(coreCash) + ' (' + formatPercent((coreCash/coreTotal)*100) + ')</td>';
            breakdownHtml += '</tr>';
            
            const divTotal = Object.values(dividendHoldings).reduce((sum, h) => sum + h.value, 0) + freeCash;
            breakdownHtml += '<tr>';
            breakdownHtml += '<td><strong>Dividend Holdings</strong></td>';
            breakdownHtml += '<td>' + formatCurrency(divTotal) + '</td>';
            breakdownHtml += '<td>' + formatCurrency(dividendEquity) + ' (' + formatPercent((dividendEquity/divTotal)*100) + ')</td>';
            breakdownHtml += '<td>$0.00 (0%)</td>';
            breakdownHtml += '<td>' + formatCurrency(dividendCash) + ' (' + formatPercent((dividendCash/divTotal)*100) + ')</td>';
            breakdownHtml += '</tr>';
            
            breakdownHtml += '<tr style="background: #f8f9fa; font-weight: 600;">';
            breakdownHtml += '<td><strong>TOTAL</strong></td>';
            breakdownHtml += '<td>' + formatCurrency(totalValue) + '</td>';
            breakdownHtml += '<td>' + formatCurrency(totalEquity) + ' (' + formatPercent(equityPct) + ')</td>';
            breakdownHtml += '<td>' + formatCurrency(totalBonds) + ' (' + formatPercent(bondsPct) + ')</td>';
            breakdownHtml += '<td>' + formatCurrency(totalCash) + ' (' + formatPercent(cashPct) + ')</td>';
            breakdownHtml += '</tr>';
            
            document.getElementById('overall_breakdown').innerHTML = breakdownHtml;
            
            // Equity breakdown
            let equityHtml = '';
            const equityBreakdown = [
                {name: 'US Equity (Core)', value: parseFloat(document.getElementById('core_swppx').value) || 0},
                {name: 'International Equity - EM (Core)', value: parseFloat(document.getElementById('core_vwo').value) || 0},
                {name: 'International Equity - Developed (Core)', value: parseFloat(document.getElementById('core_schf').value) || 0},
                {name: 'Dividend Stocks', value: dividendEquity}
            ];
            
            equityBreakdown.forEach(item => {
                const pctOfTotal = (item.value / totalValue) * 100;
                const pctOfEquity = (item.value / totalEquity) * 100;
                
                equityHtml += '<tr>';
                equityHtml += '<td>' + item.name + '</td>';
                equityHtml += '<td>' + formatCurrency(item.value) + '</td>';
                equityHtml += '<td>' + formatPercent(pctOfTotal) + '</td>';
                equityHtml += '<td>' + formatPercent(pctOfEquity) + '</td>';
                equityHtml += '</tr>';
            });
            
            document.getElementById('equity_breakdown').innerHTML = equityHtml;
            
            // Strategy comparison
            let strategyHtml = '';
            const strategies = [
                {name: 'Conservative', target: 50},
                {name: 'Moderate', target: 65},
                {name: 'Moderately Aggressive', target: 75},
                {name: 'Aggressive', target: 90}
            ];
            
            strategies.forEach(strat => {
                const diff = equityPct - strat.target;
                const absDiff = Math.abs(diff);
                let status = '';
                let statusColor = '';
                
                if (absDiff < 3) {
                    status = '‚úì On Target';
                    statusColor = '#28a745';
                } else if (diff > 0) {
                    status = '‚Üë ' + formatPercent(absDiff) + ' over';
                    statusColor = '#ffc107';
                } else {
                    status = '‚Üì ' + formatPercent(absDiff) + ' under';
                    statusColor = '#17a2b8';
                }
                
                strategyHtml += '<tr>';
                strategyHtml += '<td><strong>' + strat.name + '</strong></td>';
                strategyHtml += '<td>' + strat.target + '%</td>';
                strategyHtml += '<td>' + formatPercent(equityPct) + '</td>';
                strategyHtml += '<td>' + (diff > 0 ? '+' : '') + formatPercent(diff) + '</td>';
                strategyHtml += '<td style="color: ' + statusColor + '; font-weight: 600;">' + status + '</td>';
                strategyHtml += '</tr>';
            });
            
            document.getElementById('strategy_comparison').innerHTML = strategyHtml;
            
            // Drift warnings
            let warningHtml = '';
            
            // Get target strategy
            const targetStrategy = document.getElementById('target_strategy').value;
            const targetEquities = {
                'conservative': 50,
                'moderate': 65,
                'mod-aggressive': 75,
                'aggressive': 90
            };
            const targetEquity = targetEquities[targetStrategy];
            const targetName = {
                'conservative': 'Conservative',
                'moderate': 'Moderate',
                'mod-aggressive': 'Moderately Aggressive',
                'aggressive': 'Aggressive'
            }[targetStrategy];
            
            const drift = Math.abs(equityPct - targetEquity);
            
            // 5% drift threshold warning
            if (drift > 5) {
                warningHtml += '<div class="alert alert-warning">';
                warningHtml += 'üö® <strong>DRIFT ALERT: More than 5% off target!</strong><br>';
                warningHtml += 'Your target: ' + targetName + ' (' + targetEquity + '% equity)<br>';
                warningHtml += 'Your actual: ' + formatPercent(equityPct) + ' equity<br>';
                warningHtml += 'Drift: ' + formatPercent(drift) + ' away from target<br><br>';
                if (equityPct > targetEquity) {
                    warningHtml += 'Your portfolio is <strong>more aggressive</strong> than your target. Consider rebalancing your core holdings to add more bonds/cash.';
                } else {
                    warningHtml += 'Your portfolio is <strong>more conservative</strong> than your target. Consider rebalancing your core holdings to add more equity.';
                }
                warningHtml += '</div>';
            } else if (drift > 3) {
                warningHtml += '<div class="alert alert-warning">';
                warningHtml += '‚ö†Ô∏è <strong>Minor Drift Detected</strong><br>';
                warningHtml += 'Your target: ' + targetName + ' (' + targetEquity + '% equity)<br>';
                warningHtml += 'Your actual: ' + formatPercent(equityPct) + ' equity<br>';
                warningHtml += 'Drift: ' + formatPercent(drift) + ' away from target<br>';
                warningHtml += 'You\'re approaching the 5% warning threshold. Monitor closely.';
                warningHtml += '</div>';
            } else {
                warningHtml += '<div class="alert alert-success">';
                warningHtml += '‚úì <strong>Portfolio On Target</strong><br>';
                warningHtml += 'Your target: ' + targetName + ' (' + targetEquity + '% equity)<br>';
                warningHtml += 'Your actual: ' + formatPercent(equityPct) + ' equity<br>';
                warningHtml += 'Drift: ' + formatPercent(drift) + ' (within acceptable range)';
                warningHtml += '</div>';
            }
            
            document.getElementById('drift_warnings').innerHTML = warningHtml;
            
            // Core recommendations
            let recsHtml = '';
            
            // Calculate what core allocation needs to be to hit target
            // Formula: (coreEquity + dividendEquity) / totalValue = targetEquity
            // Solve for coreEquity: coreEquity = (targetEquity * totalValue) - dividendEquity
            
            const targetTotalEquity = totalValue * (targetEquity / 100);
            const neededCoreEquity = targetTotalEquity - dividendEquity;
            const neededCoreEquityPct = (neededCoreEquity / coreTotal) * 100;
            const neededCoreBondsCashPct = 100 - neededCoreEquityPct;
            
            const currentCoreEquityPct = (coreEquity / coreTotal) * 100;
            const currentEquityDollar = totalEquity;
            const targetEquityDollar = targetTotalEquity;
            const equityDifference = currentEquityDollar - targetEquityDollar;
            
            recsHtml += '<div class="alert alert-info">';
            recsHtml += '<strong>Target: ' + targetName + ' (' + targetEquity + '% equity overall)</strong><br>';
            recsHtml += 'Current: ' + formatPercent(equityPct) + ' equity overall<br>';
            recsHtml += 'Difference: ' + (equityDifference > 0 ? '+' : '') + formatCurrency(equityDifference) + ' in equity<br>';
            recsHtml += '</div>';
            
            if (Math.abs(equityDifference) < 1000) {
                recsHtml += '<div class="alert alert-success">';
                recsHtml += '‚úì <strong>No rebalancing needed</strong><br>';
                recsHtml += 'Your portfolio is very close to target. The difference is minimal (' + formatCurrency(Math.abs(equityDifference)) + ').';
                recsHtml += '</div>';
            } else {
                recsHtml += '<div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">';
                recsHtml += '<h3 style="color: #667eea; margin-bottom: 15px;">Rebalancing Options</h3>';
                
                if (equityDifference > 0) {
                    // Too much equity - need to reduce
                    recsHtml += '<p style="margin-bottom: 15px;"><strong>You have ' + formatCurrency(equityDifference) + ' too much in equity.</strong> Choose one of these options:</p>';
                    
                    // Option 1: Sell dividend stocks
                    recsHtml += '<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #667eea; margin-bottom: 15px;">';
                    recsHtml += '<strong>Option 1: Reduce Dividend Stock Positions</strong><br>';
                    recsHtml += '‚Ä¢ Sell ' + formatCurrency(equityDifference) + ' of dividend stocks<br>';
                    recsHtml += '‚Ä¢ Move proceeds to cash or bonds<br>';
                    recsHtml += '‚Ä¢ Keep core holdings as-is<br>';
                    recsHtml += '<em style="color: #6c757d;">Best if: You want to trim overweight dividend positions</em>';
                    recsHtml += '</div>';
                    
                    // Option 2: Adjust core to be more conservative
                    if (neededCoreEquityPct >= 0 && neededCoreEquityPct <= 100) {
                        const coreEquityToSell = coreEquity - neededCoreEquity;
                        recsHtml += '<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #667eea; margin-bottom: 15px;">';
                        recsHtml += '<strong>Option 2: Make Core More Conservative</strong><br>';
                        recsHtml += '‚Ä¢ Sell ' + formatCurrency(coreEquityToSell) + ' of core equity (SWPPX/VWO/SCHF)<br>';
                        recsHtml += '‚Ä¢ Buy ' + formatCurrency(coreEquityToSell) + ' of bonds/cash (BND/SCHO)<br>';
                        recsHtml += '‚Ä¢ Target core allocation: ' + formatPercent(neededCoreEquityPct) + ' equity / ' + formatPercent(neededCoreBondsCashPct) + ' bonds+cash<br>';
                        recsHtml += '‚Ä¢ Keep dividend stocks as-is<br>';
                        recsHtml += '<em style="color: #6c757d;">Best if: You want to preserve dividend positions</em>';
                        recsHtml += '</div>';
                    }
                    
                    // Option 3: Combination approach
                    const dividendReduction = equityDifference * 0.5;
                    const coreReduction = equityDifference * 0.5;
                    recsHtml += '<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #667eea; margin-bottom: 15px;">';
                    recsHtml += '<strong>Option 3: Balanced Approach (50/50 split)</strong><br>';
                    recsHtml += '‚Ä¢ Sell ' + formatCurrency(dividendReduction) + ' of dividend stocks<br>';
                    recsHtml += '‚Ä¢ Rebalance core to reduce equity by ' + formatCurrency(coreReduction) + '<br>';
                    recsHtml += '<em style="color: #6c757d;">Best if: You want to adjust both portfolios moderately</em>';
                    recsHtml += '</div>';
                    
                } else {
                    // Too little equity - need to increase
                    const equityNeeded = Math.abs(equityDifference);
                    recsHtml += '<p style="margin-bottom: 15px;"><strong>You need ' + formatCurrency(equityNeeded) + ' more in equity.</strong> Choose one of these options:</p>';
                    
                    // Option 1: Buy more dividend stocks
                    recsHtml += '<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #667eea; margin-bottom: 15px;">';
                    recsHtml += '<strong>Option 1: Add to Dividend Stocks</strong><br>';
                    recsHtml += '‚Ä¢ Buy ' + formatCurrency(equityNeeded) + ' more dividend stocks<br>';
                    recsHtml += '‚Ä¢ Use available cash or sell bonds<br>';
                    recsHtml += '‚Ä¢ Watch sector limits (30% max per sector)<br>';
                    recsHtml += '‚Ä¢ Keep core holdings as-is<br>';
                    recsHtml += '<em style="color: #6c757d;">Best if: You have cash to deploy and want more dividend income</em>';
                    recsHtml += '</div>';
                    
                    // Option 2: Adjust core to be more aggressive
                    if (neededCoreEquityPct >= 0 && neededCoreEquityPct <= 100) {
                        const coreEquityToBuy = neededCoreEquity - coreEquity;
                        recsHtml += '<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #667eea; margin-bottom: 15px;">';
                        recsHtml += '<strong>Option 2: Make Core More Aggressive</strong><br>';
                        recsHtml += '‚Ä¢ Sell ' + formatCurrency(coreEquityToBuy) + ' of bonds/cash (BND/SCHO)<br>';
                        recsHtml += '‚Ä¢ Buy ' + formatCurrency(coreEquityToBuy) + ' of equity (SWPPX/VWO/SCHF)<br>';
                        recsHtml += '‚Ä¢ Target core allocation: ' + formatPercent(neededCoreEquityPct) + ' equity / ' + formatPercent(neededCoreBondsCashPct) + ' bonds+cash<br>';
                        recsHtml += '‚Ä¢ Keep dividend stocks as-is<br>';
                        recsHtml += '<em style="color: #6c757d;">Best if: You want broader market exposure via index funds</em>';
                        recsHtml += '</div>';
                    }
                    
                    // Option 3: Combination approach
                    const dividendIncrease = equityNeeded * 0.5;
                    const coreIncrease = equityNeeded * 0.5;
                    recsHtml += '<div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #667eea; margin-bottom: 15px;">';
                    recsHtml += '<strong>Option 3: Balanced Approach (50/50 split)</strong><br>';
                    recsHtml += '‚Ä¢ Buy ' + formatCurrency(dividendIncrease) + ' more dividend stocks<br>';
                    recsHtml += '‚Ä¢ Increase core equity by ' + formatCurrency(coreIncrease) + '<br>';
                    recsHtml += '<em style="color: #6c757d;">Best if: You want to grow both portfolios</em>';
                    recsHtml += '</div>';
                }
                
                recsHtml += '</div>';
            }
            
            // Show current vs needed core allocation
            recsHtml += '<div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #dee2e6;">';
            recsHtml += '<strong>Current Core Allocation:</strong> ' + formatPercent(currentCoreEquityPct) + ' equity / ' + formatPercent(100 - currentCoreEquityPct) + ' bonds+cash<br>';
            
            if (neededCoreEquityPct >= 0 && neededCoreEquityPct <= 100) {
                recsHtml += '<strong>Needed Core Allocation:</strong> ' + formatPercent(neededCoreEquityPct) + ' equity / ' + formatPercent(neededCoreBondsCashPct) + ' bonds+cash<br>';
                
                const coreDiff = neededCoreEquityPct - currentCoreEquityPct;
                if (Math.abs(coreDiff) < 2) {
                    recsHtml += '<span style="color: #28a745;">‚úì Core is already at recommended allocation</span>';
                } else {
                    recsHtml += '<strong>Adjustment needed:</strong> ' + (coreDiff > 0 ? 'Increase' : 'Decrease') + ' core equity by ' + formatPercent(Math.abs(coreDiff));
                }
            } else {
                recsHtml += '<span style="color: #dc3545;">‚ö†Ô∏è Target cannot be achieved by adjusting core alone - must adjust dividend holdings</span>';
            }
            recsHtml += '</div>';
            
            document.getElementById('core_recommendations').innerHTML = recsHtml;
        }
        
        // Update cash flow
        function updateCashFlow() {
            const currentCash = parseFloat(document.getElementById('input_current_cash').value) || 0;
            const newMoney2026 = parseFloat(document.getElementById('input_new_money_2026').value) || 0;
            const monthsRemaining = parseInt(document.getElementById('input_months_remaining').value) || 0;
            const monthlyInvestment = parseFloat(document.getElementById('input_monthly_investment').value) || 0;
            
            const totalCashAvailable = currentCash + newMoney2026;
            const totalToInvest = monthsRemaining * monthlyInvestment;
            const endingCash = totalCashAvailable - totalToInvest;
            
            document.getElementById('cf_starting').textContent = formatCurrency(currentCash);
            document.getElementById('cf_months').textContent = monthsRemaining;
            document.getElementById('cf_monthly').textContent = formatCurrency(monthlyInvestment);
            document.getElementById('cf_ending').textContent = formatCurrency(endingCash);
            
            document.getElementById('cf_2027_carry').textContent = formatCurrency(endingCash);
            document.getElementById('cf_2027_total').textContent = formatCurrency(endingCash + 7500);
        }
        
        // Calculate multi-year projection
        function calculateProjection() {
            const currentPortfolio = parseFloat(document.getElementById('proj_current_portfolio').value) || 0;
            const yieldPct = parseFloat(document.getElementById('proj_yield').value) || 0;
            const annualContribution = parseFloat(document.getElementById('proj_annual_contribution').value) || 0;
            const annualNeed = parseFloat(document.getElementById('proj_annual_need').value) || 0;
            const growthPct = parseFloat(document.getElementById('proj_growth').value) || 0;
            
            const deficit = annualNeed - annualContribution;
            
            let html = '<div class="alert alert-info">';
            html += '<strong>Annual Deficit to Cover: ' + formatCurrency(deficit) + '</strong><br>';
            html += 'You need ' + formatCurrency(deficit) + ' per year from dividends + rebalancing to sustain $1,000/month investments.';
            html += '</div>';
            
            html += '<table style="margin-top: 20px;">';
            html += '<thead><tr>';
            html += '<th>Year</th>';
            html += '<th>Portfolio Value</th>';
            html += '<th>Annual Dividends</th>';
            html += '<th>Deficit Coverage</th>';
            html += '<th>Status</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            let portfolio = currentPortfolio;
            let sustainableYear = null;
            
            for (let year = 1; year <= 10; year++) {
                // Add contribution
                portfolio += annualContribution;
                
                // Calculate dividends
                const dividends = portfolio * (yieldPct / 100);
                
                // Apply growth (on the portfolio value)
                portfolio = portfolio * (1 + growthPct / 100);
                
                // Calculate coverage
                const coveragePct = (dividends / deficit) * 100;
                const shortfall = Math.max(0, deficit - dividends);
                
                let status = '';
                let rowClass = '';
                
                if (coveragePct >= 100 && !sustainableYear) {
                    sustainableYear = year;
                    status = 'üéâ SELF-SUSTAINING!';
                    rowClass = ' style="background: #d4edda; font-weight: 600;"';
                } else if (coveragePct >= 90) {
                    status = '‚ö†Ô∏è Nearly there';
                    rowClass = ' style="background: #fff3cd;"';
                } else if (coveragePct >= 75) {
                    status = 'üìà Getting close';
                } else {
                    status = 'Need ' + formatCurrency(shortfall) + ' more';
                }
                
                html += '<tr' + rowClass + '>';
                html += '<td>Year ' + year + '</td>';
                html += '<td>' + formatCurrency(portfolio) + '</td>';
                html += '<td>' + formatCurrency(dividends) + '</td>';
                html += '<td>' + formatPercent(coveragePct) + '</td>';
                html += '<td>' + status + '</td>';
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            
            if (sustainableYear) {
                html += '<div class="alert alert-success" style="margin-top: 20px;">';
                html += '<strong>üéØ Self-Sustainability Target: Year ' + sustainableYear + '</strong><br>';
                html += 'Your portfolio will generate enough dividends to cover your $' + (deficit).toFixed(0) + ' annual deficit by Year ' + sustainableYear + '.';
                html += '</div>';
            } else {
                html += '<div class="alert alert-warning" style="margin-top: 20px;">';
                html += '<strong>‚è∞ Beyond 10 Years</strong><br>';
                html += 'With current settings, it will take more than 10 years to become self-sustaining. Consider:<br>';
                html += '‚Ä¢ Increasing dividend yield (choose higher-yield stocks)<br>';
                html += '‚Ä¢ Reducing monthly investment amount<br>';
                html += '‚Ä¢ Increasing annual contributions';
                html += '</div>';
            }
            
            document.getElementById('projectionResults').innerHTML = html;
        }
        
        // Export rebalancing plan
        function exportRebalance() {
            const tickers = ['swppx', 'vwo', 'schf', 'bnd', 'scho'];
            let content = 'ROTH IRA CORE HOLDINGS - REBALANCING PLAN\n';
            content += '==========================================\n\n';
            
            let totalValue = 0;
            tickers.forEach(ticker => {
                totalValue += parseFloat(document.getElementById('core_' + ticker).value) || 0;
            });
            
            content += 'Total Portfolio Value: ' + formatCurrency(totalValue) + '\n\n';
            
            content += 'CURRENT HOLDINGS:\n';
            tickers.forEach(ticker => {
                const value = parseFloat(document.getElementById('core_' + ticker).value) || 0;
                const pct = (value / totalValue) * 100;
                content += ticker.toUpperCase() + ': ' + formatCurrency(value) + ' (' + formatPercent(pct) + ')\n';
            });
            
            content += '\nTARGET ALLOCATION:\n';
            tickers.forEach(ticker => {
                const targetPct = parseFloat(document.getElementById('target_' + ticker).value) || 0;
                const targetValue = totalValue * (targetPct / 100);
                content += ticker.toUpperCase() + ': ' + formatCurrency(targetValue) + ' (' + targetPct + '%)\n';
            });
            
            content += '\nACTIONS NEEDED:\n';
            tickers.forEach(ticker => {
                const currentValue = parseFloat(document.getElementById('core_' + ticker).value) || 0;
                const targetPct = parseFloat(document.getElementById('target_' + ticker).value) || 0;
                const targetValue = totalValue * (targetPct / 100);
                const difference = targetValue - currentValue;
                
                if (Math.abs(difference) >= 0.01) {
                    if (difference > 0) {
                        content += 'BUY ' + ticker.toUpperCase() + ': ' + formatCurrency(difference) + '\n';
                    } else {
                        content += 'SELL ' + ticker.toUpperCase() + ': ' + formatCurrency(Math.abs(difference)) + '\n';
                    }
                }
            });
            
            // Create download
            const blob = new Blob([content], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'rebalancing_plan.txt';
            a.click();
        }
        
        // Initialize on load
        window.onload = function() {
            loadCoreHoldings();
            loadDividendHoldings();
            loadDividendPayments();
            loadShareCounts();
            renderCoreTable();
            renderHoldingsSummary();
            updateOverview();
            updateOverallAllocation();
            calculateRebalance();
            updateDividendView();
            updateDividendTracker();
            updateCashFlow();
            calculateProjection();
        };
    </script>
</body>
</html>
